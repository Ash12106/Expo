{% extends "base.html" %}

{% block title %}Predictions - {{ plant.name }} | VVCE Solar ML Predictor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-layout.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h5 class="sidebar-title">
                        <i class="fas fa-solar-panel"></i>
                        Solar Plants
                    </h5>
                    <span class="sidebar-subtitle">VVCE Campus</span>
                </div>
                
                <nav class="plant-navigation">
                    {% for p in all_plants %}
                    <a href="{{ url_for('predictions', plant_id=p.id) }}" 
                       class="plant-nav-item {% if p.id == plant.id %}active{% endif %}">
                        <div class="plant-nav-content">
                            <div class="plant-nav-info">
                                <h6 class="plant-nav-name">{{ p.name }}</h6>
                                <div class="plant-nav-details">
                                    <span class="plant-nav-location">
                                        <i class="fas fa-map-marker-alt"></i>{{ p.location }}
                                    </span>
                                    <span class="plant-nav-capacity">
                                        <i class="fas fa-bolt"></i>{{ p.capacity_mw }} MW
                                    </span>
                                </div>
                            </div>
                            <div class="plant-nav-status">
                                <span class="status-dot active"></span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </nav>
                
                <div class="sidebar-footer">
                    <div class="plant-count">
                        <i class="fas fa-building"></i>
                        <span>{{ all_plants|length }} Total Plants</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-content">
                <!-- Page Header -->
                <header class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-crystal-ball"></i>
                        6-Month Predictions - {{ plant.name }}
                    </h1>
                    <p class="page-subtitle">
                        <i class="fas fa-brain"></i> AI-powered forecasts using advanced physics-based models
                        &nbsp;•&nbsp;
                        <i class="fas fa-calendar"></i> 26-week detailed analysis
                        &nbsp;•&nbsp;
                        <i class="fas fa-chart-line"></i> {{ predictions|length if predictions else 0 }} predictions generated
                    </p>
                </header>

                {% if predictions %}
                <!-- Summary Statistics -->
                <div class="stats-grid">
                    {% set total_energy = predictions | map(attribute='predicted_energy') | sum %}
                    {% set total_revenue = predictions | map(attribute='predicted_revenue') | sum %}
                    {% set avg_efficiency = (predictions | map(attribute='predicted_efficiency') | sum / predictions|length) %}
                    {% set avg_confidence = (predictions | map(attribute='confidence_score') | sum / predictions|length) %}
                    
                    <div class="stat-card primary">
                        <div class="stat-header">
                            <div class="stat-icon primary">
                                <i class="fas fa-bolt"></i>
                            </div>
                        </div>
                        <div class="stat-value">{{ '{:,.0f}'.format(total_energy) }}</div>
                        <div class="stat-label">Total Energy (kWh)</div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-icon success">
                                <i class="fas fa-rupee-sign"></i>
                            </div>
                        </div>
                        <div class="stat-value">₹{{ '{:,.0f}'.format(total_revenue) }}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>

                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-icon warning">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-value">{{ '{:.1f}'.format(avg_efficiency) }}%</div>
                        <div class="stat-label">Avg Efficiency</div>
                    </div>

                    <div class="stat-card info">
                        <div class="stat-header">
                            <div class="stat-icon info">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="stat-value">{{ '{:.0f}'.format(avg_confidence * 100) }}%</div>
                        <div class="stat-label">Confidence Score</div>
                    </div>
                </div>

                <!-- Prediction Charts -->
                <div class="content-grid">
                    <!-- Energy Prediction Chart -->
                    <section class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-bolt"></i>
                                Energy Production Forecast
                            </h2>
                            <div class="section-actions">
                                <button class="action-btn secondary" onclick="downloadPredictions('energy')">
                                    <i class="fas fa-download"></i>
                                    Export Data
                                </button>
                                <a href="{{ url_for('dashboard', plant_id=plant.id) }}" class="action-btn primary">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Back to Dashboard
                                </a>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="energyPredictionChart"></canvas>
                        </div>
                    </section>

                    <!-- Revenue Prediction Chart -->
                    <section class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-rupee-sign"></i>
                                Revenue Forecast
                            </h2>
                            <div class="section-actions">
                                <button class="action-btn info" onclick="showRevenueDetails()">
                                    <i class="fas fa-info-circle"></i>
                                    Details
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenuePredictionChart"></canvas>
                        </div>
                    </section>

                    <!-- Efficiency Prediction Chart -->
                    <section class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-cogs"></i>
                                Efficiency Trends
                            </h2>
                            <div class="section-actions">
                                <button class="action-btn warning" onclick="showMaintenanceRecommendations()">
                                    <i class="fas fa-tools"></i>
                                    Maintenance Tips
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="efficiencyPredictionChart"></canvas>
                        </div>
                    </section>

                    <!-- Monthly Summary -->
                    <section class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-calendar-alt"></i>
                                Monthly Forecast Summary
                            </h2>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyForecastChart"></canvas>
                        </div>
                    </section>
                </div>

                <!-- Detailed Predictions Table -->
                <section class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-table"></i>
                            Detailed Weekly Predictions
                        </h2>
                        <div class="section-actions">
                            <button class="action-btn secondary" onclick="toggleTableView()">
                                <i class="fas fa-eye"></i>
                                Toggle View
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Week</th>
                                    <th>Date</th>
                                    <th>Energy (kWh)</th>
                                    <th>Revenue (₹)</th>
                                    <th>Efficiency (%)</th>
                                    <th>Confidence</th>
                                    <th>Model</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for prediction in predictions[:26] %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ prediction.prediction_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ '{:.1f}'.format(prediction.predicted_energy) }}</td>
                                    <td>₹{{ '{:,.0f}'.format(prediction.predicted_revenue) }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if prediction.predicted_efficiency >= 18 %}bg-success
                                            {% elif prediction.predicted_efficiency >= 15 %}bg-primary
                                            {% elif prediction.predicted_efficiency >= 12 %}bg-warning
                                            {% else %}bg-danger
                                            {% endif %}">
                                            {{ '{:.1f}'.format(prediction.predicted_efficiency) }}%
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar 
                                                {% if prediction.confidence_score >= 0.8 %}bg-success
                                                {% elif prediction.confidence_score >= 0.6 %}bg-primary
                                                {% else %}bg-warning
                                                {% endif %}" 
                                                style="width: {{ prediction.confidence_score * 100 }}%">
                                                {{ '{:.0f}'.format(prediction.confidence_score * 100) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ prediction.model_used }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>

                {% else %}
                <!-- No Predictions Available -->
                <div class="content-section text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-chart-line fa-5x text-muted opacity-50"></i>
                    </div>
                    <h3 class="text-muted mb-3">No Predictions Available</h3>
                    <p class="text-muted mb-4">Generate AI-powered 6-month forecasts for {{ plant.name }}</p>
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{{ url_for('dashboard', plant_id=plant.id) }}" class="action-btn primary">
                            <i class="fas fa-arrow-left"></i>
                            Back to Dashboard
                        </a>
                        <button class="action-btn success" onclick="generatePredictions()">
                            <i class="fas fa-magic"></i>
                            Generate Predictions
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prediction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const plantId = '{{ plant.id }}';
    
    {% if predictions %}
    // Initialize prediction charts
    if (typeof initializePredictionCharts === 'function') {
        initializePredictionCharts(plantId);
    }
    {% endif %}
});

function downloadPredictions(type) {
    const plantId = '{{ plant.id }}';
    window.open(`/api/export_predictions/${plantId}?type=${type}`, '_blank');
}

function showRevenueDetails() {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    document.getElementById('modalContent').innerHTML = `
        <h6>Revenue Calculation Details</h6>
        <p>Revenue predictions are calculated based on:</p>
        <ul>
            <li>Predicted energy output (kWh)</li>
            <li>Current tariff rates (₹/kWh)</li>
            <li>Seasonal adjustments</li>
            <li>Market conditions</li>
        </ul>
        <p class="text-muted">All values are in Indian Rupees (INR).</p>
    `;
    modal.show();
}

function showMaintenanceRecommendations() {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    document.getElementById('modalContent').innerHTML = `
        <h6>Maintenance Recommendations</h6>
        <div class="alert alert-info">
            <strong>Proactive maintenance helps maintain peak efficiency!</strong>
        </div>
        <ul>
            <li>Clean panels every 2-3 weeks during dry season</li>
            <li>Check inverter performance monthly</li>
            <li>Inspect connections before monsoon season</li>
            <li>Monitor efficiency drops > 5%</li>
        </ul>
    `;
    modal.show();
}

function toggleTableView() {
    const table = document.querySelector('.table-responsive');
    table.style.display = table.style.display === 'none' ? 'block' : 'none';
}

function generatePredictions() {
    const plantId = '{{ plant.id }}';
    window.location.href = `/dashboard/${plantId}`;
}
</script>
{% endblock %}