{% extends "base.html" %}

{% block title %}Dashboard - {{ plant.name }} | VVCE Solar ML Predictor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/clean-layout.css') }}">
{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Sidebar -->
    <aside class="app-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="fas fa-solar-panel"></i>
                Solar Plants
            </div>
            <div class="sidebar-subtitle">VVCE Campus</div>
        </div>
        
        <div class="plant-list">
            {% for p in all_plants %}
            <a href="{{ url_for('dashboard', plant_id=p.id) }}" 
               class="plant-item {% if p.id == plant.id %}active{% endif %}">
                <div class="plant-name">{{ p.name }}</div>
                <div class="plant-details">
                    <div class="plant-location">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ p.location }}
                    </div>
                    <div class="plant-capacity">
                        <i class="fas fa-bolt"></i>
                        {{ p.capacity_mw }} MW
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        
        <div class="sidebar-footer">
            <i class="fas fa-building"></i>
            {{ all_plants|length }} Total Plants
        </div>
    </aside>

    <!-- Main Content -->
    <main class="app-main">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-solar-panel" style="color: #f59e0b;"></i>
                {{ plant.name }}
            </h1>
            <p class="page-subtitle">
                <i class="fas fa-map-marker-alt"></i> {{ plant.location }} •
                <i class="fas fa-bolt"></i> {{ plant.capacity_mw }} MW Capacity •
                <i class="fas fa-calendar"></i> Installed {{ plant.installation_date.strftime('%B %Y') }}
            </p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                </div>
                <div class="stat-value">{{ '{:.1f}'.format(current_efficiency or 15.8) }}%</div>
                <div class="stat-label">System Efficiency</div>
            </div>

            <div class="stat-card success">
                <div class="stat-header">
                    <div class="stat-icon success">
                        <i class="fas fa-bolt"></i>
                    </div>
                </div>
                <div class="stat-value">{{ '{:.1f}'.format(today_production or 42.3) }}</div>
                <div class="stat-label">Today's Energy (kWh)</div>
            </div>

            <div class="stat-card warning">
                <div class="stat-header">
                    <div class="stat-icon warning">
                        <i class="fas fa-rupee-sign"></i>
                    </div>
                </div>
                <div class="stat-value">₹{{ '{:,.0f}'.format(today_revenue or 2540) }}</div>
                <div class="stat-label">Today's Revenue</div>
            </div>

            <div class="stat-card" style="border-top-color: #06b6d4;">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #06b6d4;">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                </div>
                <div class="stat-value">{{ current_weather.temperature or 28 }}°C</div>
                <div class="stat-label">Current Temperature</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-box">
            <div class="chart-header">
                <h2 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Energy Production Trends
                </h2>
                <div class="flex gap-2">
                    <button class="btn btn-secondary btn-sm" onclick="refreshCharts()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <a href="{{ url_for('predictions', plant_id=plant.id) }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-crystal-ball"></i>
                        View Predictions
                    </a>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="productionChart"></canvas>
            </div>
        </div>

        <div class="content-grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
            <!-- Revenue Chart -->
            <div class="chart-box">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <i class="fas fa-rupee-sign"></i>
                        Revenue Analytics
                    </h2>
                </div>
                <div class="chart-content">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Efficiency Chart -->
            <div class="chart-box">
                <div class="chart-header">
                    <h2 class="chart-title">
                        <i class="fas fa-cogs"></i>
                        System Performance
                    </h2>
                </div>
                <div class="chart-content">
                    <canvas id="efficiencyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Action Cards -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-brain"></i>
                    Machine Learning Models
                </h2>
            </div>
            <div class="section-content">
                <div class="action-grid">
                    <div class="action-card">
                        <button class="btn btn-primary" onclick="trainRealisticModel('{{ plant.id }}')">
                            <i class="fas fa-brain"></i>
                            Train Physics Model
                        </button>
                        <p class="text-sm opacity-75 mt-2">Using real weather data</p>
                    </div>
                    
                    <div class="action-card">
                        <button class="btn btn-success" onclick="generateRealisticPredictions('{{ plant.id }}')">
                            <i class="fas fa-chart-line"></i>
                            Generate Forecasts
                        </button>
                        <p class="text-sm opacity-75 mt-2">6-month predictions</p>
                    </div>
                    
                    <div class="action-card">
                        <a href="{{ url_for('analytics_dashboard', plant_id=plant.id) }}" class="btn" style="background: #06b6d4; color: white;">
                            <i class="fas fa-chart-pie"></i>
                            Advanced Analytics
                        </a>
                        <p class="text-sm opacity-75 mt-2">Detailed insights</p>
                    </div>
                    
                    <div class="action-card">
                        <a href="{{ url_for('data_editor', plant_id=plant.id) }}" class="btn btn-warning">
                            <i class="fas fa-edit"></i>
                            Data Editor
                        </a>
                        <p class="text-sm opacity-75 mt-2">Manage data</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingMessage">Processing...</h5>
                <p class="text-muted mb-0">Please wait while we process your request.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const plantId = '{{ plant.id }}';
    
    // Initialize charts
    if (typeof initializeCharts === 'function') {
        initializeCharts(plantId);
    }
    
    console.log('Clean Dashboard initialized for plant:', plantId);
});

function refreshCharts() {
    showLoadingModal('Refreshing charts...');
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function showLoadingModal(message) {
    document.getElementById('loadingMessage').textContent = message;
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
}

function hideLoadingModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (modal) {
        modal.hide();
    }
}

function trainRealisticModel(plantId) {
    showLoadingModal('Training physics-based ML model...');
    
    fetch(`/api/train_model/${plantId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        if (data.success) {
            alert('Model trained successfully!');
            location.reload();
        } else {
            alert('Error training model: ' + data.message);
        }
    })
    .catch(error => {
        hideLoadingModal();
        alert('Error: ' + error.message);
    });
}

function generateRealisticPredictions(plantId) {
    showLoadingModal('Generating 6-month predictions...');
    
    fetch(`/api/generate_predictions/${plantId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoadingModal();
        if (data.success) {
            alert('Predictions generated successfully!');
            window.location.href = `/predictions/${plantId}`;
        } else {
            alert('Error generating predictions: ' + data.message);
        }
    })
    .catch(error => {
        hideLoadingModal();
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}