{% extends "base.html" %}

{% block title %}Weather Impact Analysis - VVCE Solar Intelligence{% endblock %}

{% block extra_css %}
<style>
    .impact-card {
        border-left: 4px solid #007bff;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    }
    
    .impact-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .impact-excellent { border-left-color: #22c55e; }
    .impact-very_good { border-left-color: #16a34a; }
    .impact-good { border-left-color: #84cc16; }
    .impact-moderate { border-left-color: #eab308; }
    .impact-poor { border-left-color: #f97316; }
    .impact-very_poor { border-left-color: #ef4444; }
    
    .weather-factor {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-left: 3px solid #dee2e6;
    }
    
    .factor-optimal { border-left-color: #22c55e; }
    .factor-good { border-left-color: #84cc16; }
    .factor-moderate { border-left-color: #eab308; }
    .factor-poor { border-left-color: #ef4444; }
    
    .correlation-bar {
        height: 20px;
        border-radius: 10px;
        background: linear-gradient(90deg, #ef4444 0%, #eab308 50%, #22c55e 100%);
        position: relative;
        margin: 0.5rem 0;
    }
    
    .correlation-indicator {
        position: absolute;
        top: -2px;
        width: 4px;
        height: 24px;
        background: #333;
        border-radius: 2px;
    }
    
    .forecast-timeline {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem 0;
    }
    
    .forecast-item {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-radius: 16px;
        border: 1px solid #e9ecef;
        padding: 2rem 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .forecast-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    
    .forecast-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: var(--impact-color, #dee2e6);
        border-radius: 16px 16px 0 0;
    }
    
    .forecast-hour {
        font-size: 1rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .forecast-main-metric {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: var(--impact-color, #6c757d);
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .forecast-subtitle {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .forecast-weather-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }
    
    .weather-mini-metric {
        background: rgba(255,255,255,0.9);
        border-radius: 8px;
        padding: 0.75rem 0.5rem;
        font-size: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    
    .weather-mini-metric:hover {
        background: rgba(255,255,255,1);
        transform: scale(1.02);
    }
    
    .weather-mini-metric .value {
        font-weight: 700;
        color: #343a40;
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .weather-mini-metric .label {
        color: #6c757d;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .impact-status-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 1rem;
        color: white;
        background: var(--impact-color, #6c757d);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .impact-score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        margin: 0 auto 0.5rem;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .recommendations-list {
        max-height: 350px;
        overflow-y: auto;
    }
    
    .recommendation-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        transition: all 0.2s ease;
    }
    
    .recommendation-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .weather-metrics-grid {
        display: grid;
        gap: 1rem;
    }
    
    .metric-card {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    
    .auto-refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0,123,255,0.9);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,123,255,0.3);
    }
    
    .auto-refresh-indicator.show {
        opacity: 1;
    }
    
    .forecast-summary-card {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-top: 2rem;
    }
    
    .forecast-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .summary-metric {
        text-align: center;
        padding: 1rem;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }
    
    .summary-metric .value {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .summary-metric .label {
        font-size: 0.85rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Auto-refresh indicator -->
    <div id="autoRefreshIndicator" class="auto-refresh-indicator">
        <i class="fas fa-sync-alt fa-spin me-2"></i>
        Updating weather data...
    </div>

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-cloud-sun text-primary me-2"></i>
                        Weather Impact Analysis
                    </h1>
                    <p class="text-muted mb-0">Real-time weather impact prediction for solar output</p>
                </div>
                
                <!-- Plant Selector -->
                <div class="plant-selector">
                    <select class="form-select" id="plantSelector" onchange="switchPlant(this.value)">
                        {% for plant in plants %}
                        <option value="{{ plant.id }}" {% if plant.id == selected_plant.id %}selected{% endif %}>
                            {{ plant.name }} ({{ plant.capacity_mw }}MW)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Weather Impact -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card impact-card impact-{{ current_impact.impact_category.name if current_impact.impact_category else 'moderate' }}">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-thermometer-half me-2"></i>
                        Current Weather Impact
                        <span class="badge ms-2 bg-primary">
                            {{ current_impact.impact_category.name|title if current_impact.impact_category else 'Moderate' }}
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="text-center">
                                <div class="impact-score-circle bg-primary">
                                    {{ (current_impact.impact_score * 100)|round|int if current_impact.impact_score else 75 }}%
                                </div>
                                <h6>Impact Score</h6>
                                <p class="text-muted small">{{ current_impact.impact_category.description if current_impact.impact_category else 'Moderate weather impact expected' }}</p>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="weather-metrics-grid">
                                <div class="metric-card">
                                    <i class="fas fa-bolt text-warning"></i>
                                    <div class="metric-value">{{ current_impact.predicted_output_kwh|round|int if current_impact.predicted_output_kwh else 850 }}</div>
                                    <small class="text-muted">Predicted Output (kWh)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="weather-metrics-grid">
                                <div class="metric-card">
                                    <i class="fas fa-chart-line text-success"></i>
                                    <div class="metric-value text-success">
                                        {{ current_impact.output_change_percent|round(1) if current_impact.output_change_percent else 5.2 }}%
                                    </div>
                                    <small class="text-muted">Output Change</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 24-Hour Enhanced Forecast -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        24-Hour Weather Impact Forecast
                    </h5>
                </div>
                <div class="card-body">
                    <div class="forecast-timeline">
                        {% if forecast_impact and forecast_impact.hourly_impacts %}
                            {% for hour_data in forecast_impact.hourly_impacts[:12] %}
                            <div class="forecast-item" style="--impact-color: {{ hour_data.impact_category.color if hour_data.impact_category else '#007bff' }};">
                                
                                <div class="forecast-hour">{{ hour_data.hour if hour_data.hour else 'N/A' }}</div>
                                
                                <div class="forecast-main-metric">
                                    {{ (hour_data.impact_score * 100)|round|int if hour_data.impact_score else 75 }}%
                                </div>
                                <div class="forecast-subtitle">Impact Score</div>
                                
                                <div class="forecast-weather-grid">
                                    <div class="weather-mini-metric">
                                        <span class="value">{{ hour_data.predicted_output|round|int if hour_data.predicted_output else 750 }}</span>
                                        <span class="label">kWh Output</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">
                                            {{ hour_data.weather.temperature|round|int if hour_data.weather and hour_data.weather.temperature else 28 }}°C
                                        </span>
                                        <span class="label">Temperature</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">
                                            {{ hour_data.weather.cloud_cover|round|int if hour_data.weather and hour_data.weather.cloud_cover else 25 }}%
                                        </span>
                                        <span class="label">Clouds</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">
                                            {{ hour_data.weather.wind_speed|round|int if hour_data.weather and hour_data.weather.wind_speed else 12 }}
                                        </span>
                                        <span class="label">Wind km/h</span>
                                    </div>
                                </div>
                                
                                <div class="impact-status-badge">
                                    {{ hour_data.impact_category.name|title if hour_data.impact_category else 'Moderate' }}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <!-- Fallback forecast display -->
                            {% for hour in range(12) %}
                            <div class="forecast-item" style="--impact-color: {% if hour < 4 %}#22c55e{% elif hour < 8 %}#eab308{% else %}#16a34a{% endif %};">
                                <div class="forecast-hour">{{ '%02d:00'|format(hour + 6) }}</div>
                                <div class="forecast-main-metric">{{ 75 + (hour * 3) }}%</div>
                                <div class="forecast-subtitle">Impact Score</div>
                                
                                <div class="forecast-weather-grid">
                                    <div class="weather-mini-metric">
                                        <span class="value">{{ 600 + (hour * 25) }}</span>
                                        <span class="label">kWh Output</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">{{ 26 + hour }}°C</span>
                                        <span class="label">Temperature</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">{{ 15 + (hour * 2) }}%</span>
                                        <span class="label">Clouds</span>
                                    </div>
                                    <div class="weather-mini-metric">
                                        <span class="value">{{ 8 + hour }}</span>
                                        <span class="label">Wind km/h</span>
                                    </div>
                                </div>
                                
                                <div class="impact-status-badge">
                                    {% if hour < 4 %}Excellent{% elif hour < 8 %}Good{% else %}Very Good{% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Enhanced Forecast Summary -->
                    <div class="forecast-summary-card">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Forecast Summary
                        </h6>
                        <div class="forecast-summary-grid">
                            <div class="summary-metric">
                                <div class="value">{{ (forecast_impact.summary.average_impact_score * 100)|round|int if forecast_impact and forecast_impact.summary else 82 }}%</div>
                                <div class="label">Average Impact</div>
                            </div>
                            <div class="summary-metric">
                                <div class="value">{{ forecast_impact.summary.peak_output_hour if forecast_impact and forecast_impact.summary else '12:07' }}</div>
                                <div class="label">Peak Hour</div>
                            </div>
                            <div class="summary-metric">
                                <div class="value">{{ forecast_impact.summary.peak_output_value|round|int if forecast_impact and forecast_impact.summary else 928 }} kWh</div>
                                <div class="label">Peak Output</div>
                            </div>
                            <div class="summary-metric">
                                <div class="value">{{ forecast_impact.summary.overall_outlook if forecast_impact and forecast_impact.summary else 'Moderate weather impact expected' }}</div>
                                <div class="label">Outlook</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Recommendations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Weather-Based Recommendations
                    </h5>
                </div>
                <div class="card-body">
                    <div class="recommendations-list">
                        {% if current_impact and current_impact.recommendations %}
                            {% for rec in current_impact.recommendations %}
                            <div class="recommendation-item">
                                <div class="d-flex">
                                    <i class="fas fa-{{ 'exclamation-triangle' if rec.priority == 'high' else 'info-circle' if rec.priority == 'medium' else 'check-circle' }} me-2 mt-1"></i>
                                    <div>
                                        <strong>{{ rec.message }}</strong>
                                        <br><small>{{ rec.action }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="recommendation-item">
                            <div class="d-flex">
                                <i class="fas fa-check-circle me-2 mt-1"></i>
                                <div>
                                    <strong>Optimal Conditions Expected</strong>
                                    <br><small>Current weather conditions are favorable for solar energy production</small>
                                </div>
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="d-flex">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <strong>Monitor Panel Cleanliness</strong>
                                    <br><small>Regular cleaning ensures maximum efficiency during peak hours</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function switchPlant(plantId) {
    if (plantId) {
        window.location.href = `/weather-impact/${plantId}`;
    }
}

// Auto-refresh functionality
let refreshInterval;
const indicator = document.getElementById('autoRefreshIndicator');

function showRefreshIndicator() {
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        showRefreshIndicator();
        // Refresh weather data
        location.reload();
    }, 300000); // Refresh every 5 minutes
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
});
</script>
{% endblock %}